<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒêƒÉng nh·∫≠p - The Besties Gang Wiki</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <script src="../config.js"></script>
  <script src="../js/auth.js"></script>
  <style>
    :root {
      --pink: #ff5faf;
      --pink-soft: #ffd0e8;
      --pink-deep: #ff2b8a;
      --bg: #05040a;
      --text-main: #ffffff;
      --text-muted: #c9c3cf;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-pink: 0 10px 40px rgba(255, 95, 175, 0.4);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: "Roboto", system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #3d1f4d 0%, #1a0d2e 30%, #05040a 60%, #0a0512 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      width: 100%;
    }

    .bg-blur {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 50% -30%, rgba(255, 182, 219, 0.35), transparent 60%),
        radial-gradient(circle at 0% 50%, rgba(255, 96, 167, 0.25), transparent 70%),
        radial-gradient(circle at 100% 50%, rgba(255, 182, 219, 0.2), transparent 70%);
      mix-blend-mode: screen;
      opacity: 0.95;
      z-index: -1;
      animation: bgShift 8s ease-in-out infinite;
    }

    @keyframes bgShift {
      0%, 100% { opacity: 0.95; }
      50% { opacity: 1; }
    }

    .container {
      width: 100%;
      height: 100vh;
      max-width: none;
      padding: 0;
      position: relative;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      background: linear-gradient(135deg, 
        rgba(20, 8, 25, 0.85) 0%, 
        rgba(25, 10, 35, 0.9) 50%, 
        rgba(15, 5, 20, 0.88) 100%);
      border: 2px solid rgba(255, 182, 219, 0.15);
      border-radius: 28px;
      padding: 48px 40px;
      box-shadow: 
        var(--shadow-soft),
        inset 0 1px 20px rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      width: 100%;
      max-width: 480px;
      min-height: auto;
    }

    .card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255, 95, 175, 0.1), transparent 70%);
      border-radius: 50%;
      filter: blur(40px);
      pointer-events: none;
    }

    .card::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -10%;
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, rgba(255, 182, 219, 0.08), transparent 70%);
      border-radius: 50%;
      filter: blur(40px);
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .logo-section {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeInDown 0.8s ease-out;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-img {
      width: 100px;
      height: auto;
      margin-bottom: 24px;
      filter: drop-shadow(0 8px 16px rgba(255, 95, 175, 0.3));
      animation: bounce 3s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    h1 {
      font-size: 32px;
      margin: 0 0 6px;
      letter-spacing: 0.02em;
      font-weight: 700;
      background: linear-gradient(135deg, #ffffff 0%, #ffd0e8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 13px;
      margin: 0;
      font-weight: 400;
      letter-spacing: 0.5px;
    }

    .form-group {
      margin-bottom: 20px;
      animation: fadeIn 0.6s ease-out backwards;
    }

    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.2s; }
    .form-group:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-main);
      letter-spacing: 0.3px;
      text-transform: capitalize;
    }

    input {
      width: 100%;
      padding: 13px 16px;
      border-radius: 14px;
      border: 1.5px solid rgba(255, 182, 219, 0.2);
      background: rgba(5, 0, 10, 0.4);
      color: var(--text-main);
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    input:hover {
      border-color: rgba(255, 182, 219, 0.4);
      background: rgba(5, 0, 10, 0.5);
    }

    input:focus {
      outline: none;
      border-color: var(--pink);
      background: rgba(5, 0, 10, 0.7);
      box-shadow: 
        0 0 0 4px rgba(255, 95, 175, 0.15),
        inset 0 0 10px rgba(255, 95, 175, 0.08);
    }

    .btn {
      width: 100%;
      padding: 13px 24px;
      border-radius: 14px;
      border: none;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 28px;
      letter-spacing: 0.5px;
      animation: fadeIn 0.6s ease-out 0.4s backwards;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--pink) 0%, var(--pink-deep) 100%);
      color: #160614;
      box-shadow: var(--shadow-pink), inset 0 1px 10px rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn.primary:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 15px 50px rgba(255, 95, 175, 0.5),
        inset 0 1px 10px rgba(255, 255, 255, 0.3);
    }

    .btn.primary:active {
      transform: translateY(-1px);
    }

    .btn.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn.discord-btn {
      background: #5865F2;
      color: #ffffff;
      box-shadow: 0 10px 30px rgba(88, 101, 242, 0.3);
      margin-top: 0;
    }

    .btn.discord-btn:hover {
      background: #4752C4;
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(88, 101, 242, 0.4);
    }

    .btn.discord-btn:active {
      transform: translateY(-1px);
    }

    .btn.discord-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 24px 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid rgba(255, 182, 219, 0.2);
    }

    .divider span {
      padding: 0 16px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 13px;
      margin-bottom: 20px;
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.show {
      display: block;
    }

    .error-message {
      background: rgba(255, 107, 107, 0.12);
      border: 1.5px solid rgba(255, 107, 107, 0.3);
      color: #ff8a8a;
    }

    .success-message {
      background: rgba(81, 207, 102, 0.12);
      border: 1.5px solid rgba(81, 207, 102, 0.3);
      color: #6ee7a0;
    }

    .info-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 182, 219, 0.1);
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      animation: fadeIn 0.6s ease-out 0.5s backwards;
    }

    .info-section p {
      margin: 0 0 8px;
      line-height: 1.6;
    }

    .info-section strong {
      color: var(--pink-soft);
      font-weight: 600;
    }

    .loading {
      display: none;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading.show {
      display: inline-block;
    }

    @media (max-width: 640px) {
      .container {
        padding: 16px;
      }

      .card {
        padding: 32px 24px;
        border-radius: 24px;
      }

      h1 {
        font-size: 26px;
      }

      .logo-img {
        width: 80px;
      }

      .btn {
        padding: 12px 20px;
        font-size: 14px;
      }

      .info-section {
        font-size: 10px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }

      .card {
        padding: 28px 20px;
      }

      h1 {
        font-size: 22px;
      }

      .logo-img {
        width: 70px;
        margin-bottom: 16px;
      }

      label {
        font-size: 11px;
      }

      input {
        padding: 11px 14px;
        font-size: 13px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .btn {
        padding: 11px 18px;
        font-size: 13px;
        margin-top: 24px;
      }

      .info-section {
        margin-top: 24px;
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <div class="bg-blur"></div>

  <div class="container">
    <div class="card">
      <div class="logo-section">
        <img src="../images/logo_thebesties.png" alt="The Besties Logo" class="logo-img" />
        <h1>ƒêƒÉng nh·∫≠p</h1>
        <p class="subtitle">C·ªông ƒë·ªìng The Besties Gang</p>
      </div>

      <div class="message error-message" id="errorMessage"></div>
      <div class="message success-message" id="successMessage"></div>

      <!-- Discord Login Section -->
      <div id="discordLoginSection">
        <!-- Discord OAuth2 Login Button -->
        <button type="button" id="discordOAuthBtn" class="btn discord-btn">
          <svg width="20" height="20" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 10px;">
            <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.6494 49.6202 53.1159 44.3151C53.1915 44.2785 53.2811 44.2898 53.3454 44.3433C53.7008 44.6363 54.0731 44.9293 54.4454 45.2082C54.5741 45.304 54.5629 45.5041 54.423 45.5858C52.6543 46.6197 50.8156 47.4931 48.8846 48.2228C48.7587 48.2707 48.6999 48.4172 48.7615 48.5383C49.8053 50.6034 51.0227 52.5699 52.3884 54.435C52.4472 54.5139 52.5451 54.5477 52.6375 54.5195C58.4118 52.7249 64.2945 50.0174 70.3674 45.5576C70.4178 45.5182 70.4542 45.459 70.4598 45.3942C71.9357 30.0791 68.7007 16.7757 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="currentColor"/>
          </svg>
          <span id="discordOAuthBtnText">ƒêƒÉng nh·∫≠p v·ªõi Discord</span>
        </button>

        <div class="divider">
          <span>ho·∫∑c</span>
        </div>

        <!-- Discord Bot Verification Login -->
        <button type="button" id="discordBotBtn" class="btn discord-btn" style="background: #5865F2; margin-top: 0;">
          <svg width="20" height="20" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 10px;">
            <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.6494 49.6202 53.1159 44.3151C53.1915 44.2785 53.2811 44.2898 53.3454 44.3433C53.7008 44.6363 54.0731 44.9293 54.4454 45.2082C54.5741 45.304 54.5629 45.5041 54.423 45.5858C52.6543 46.6197 50.8156 47.4931 48.8846 48.2228C48.7587 48.2707 48.6999 48.4172 48.7615 48.5383C49.8053 50.6034 51.0227 52.5699 52.3884 54.435C52.4472 54.5139 52.5451 54.5477 52.6375 54.5195C58.4118 52.7249 64.2945 50.0174 70.3674 45.5576C70.4178 45.5182 70.4542 45.459 70.4598 45.3942C71.9357 30.0791 68.7007 16.7757 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="currentColor"/>
          </svg>
          <span id="discordBotBtnText">Li√™n k·∫øt v·ªõi Bot Discord c·ªßa Gang</span>
        </button>
        
        <!-- Verification Code Display -->
        <div id="verificationSection" style="display: none; margin-top: 24px; padding: 20px; background: rgba(88, 101, 242, 0.1); border-radius: 14px; border: 1.5px solid rgba(88, 101, 242, 0.3);">
          <p style="margin: 0 0 16px; font-size: 14px; color: var(--text-main); text-align: center;">
            üì± <strong>G·ª≠i code n√†y cho bot Discord qua tin nh·∫Øn ri√™ng (DM):</strong>
          </p>
          <div style="text-align: center; margin-bottom: 16px;">
            <div id="verificationCode" style="font-size: 32px; font-weight: 700; letter-spacing: 8px; color: #5865F2; font-family: 'Courier New', monospace; padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; display: inline-block; margin: 0 auto;"></div>
          </div>
          <p style="margin: 0; font-size: 12px; color: var(--text-muted); text-align: center; line-height: 1.6;">
            üí¨ M·ªü Discord ‚Üí T√¨m bot "The Besties Bot" ‚Üí G·ª≠i tin nh·∫Øn ri√™ng v·ªõi code tr√™n<br>
            ‚è±Ô∏è Code c√≥ hi·ªáu l·ª±c trong <span id="countdown">5:00</span> ph√∫t
          </p>
          <div id="verificationStatus" style="margin-top: 16px; text-align: center; font-size: 13px; color: var(--text-muted);">
            ‚è≥ ƒêang ch·ªù x√°c th·ª±c...
          </div>
        </div>
      </div>

      <!-- Legacy Username/Password Form (Optional) -->
      <form id="loginForm" style="display: none;">
        <div class="form-group">
          <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" 
            autocomplete="username"
            required 
          />
        </div>

        <div class="form-group">
          <label for="password">M·∫≠t kh·∫©u</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="Nh·∫≠p m·∫≠t kh·∫©u" 
            autocomplete="current-password"
            required 
          />
        </div>

        <button type="submit" class="btn primary">
          <span class="loading" id="loading">‚è≥</span>
          <span id="btnText">ƒêƒÉng nh·∫≠p</span>
        </button>
      </form>

      <div class="info-section">
        <p style="margin-bottom: 8px;">
          <strong>ƒêƒÉng nh·∫≠p & li√™n k·∫øt Bot Discord:</strong><br>
          <span style="font-size: 11px; color: var(--text-muted);">
            ‚Ä¢ ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Discord c·ªßa b·∫°n<br>
            ‚Ä¢ Li√™n k·∫øt v·ªõi Bot Discord c·ªßa Gang ƒë·ªÉ m·ªü kh√≥a ch·ªânh s·ª≠a profile
          </span>
        </p>
        <p style="margin-top: 10px; font-size: 10px; color: var(--text-muted);">
          Admin: Client ID/Secret c·ªßa bot n·∫±m trong Discord Developer Portal (tab <em>General Information</em> / <em>OAuth2</em>) ‚Üí d√°n v√†o file <code>backend/.env</code> v·ªõi c√°c kh√≥a <code>DISCORD_CLIENT_ID</code>, <code>DISCORD_CLIENT_SECRET</code>, <code>DISCORD_BOT_TOKEN</code>, r·ªìi kh·ªüi ƒë·ªông l·∫°i backend/bot.
        </p>
        <p style="margin-top: 12px; font-size: 10px; color: var(--text-muted);">
          ¬© 2025 The Besties Gang ‚Ä¢ FiveM<br>
          <span style="color: var(--pink-soft);">M√†u h·ªìng nh∆∞ng kh√¥ng y·∫øu ƒëu·ªëi.</span>
        </p>
      </div>
    </div>
  </div>

  <script>
    // Check if this is an OAuth callback
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');

    // Handle OAuth callback
    if (code && state) {
      // This is a Discord OAuth callback
      (async () => {
        try {
          if (window.Auth) {
            await window.Auth.handleDiscordCallback(code, state);
          } else {
            // Wait for auth.js to load
            setTimeout(async () => {
              if (window.Auth) {
                await window.Auth.handleDiscordCallback(code, state);
              } else {
                showError('‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫£i authentication module');
              }
            }, 500);
          }
        } catch (error) {
          console.error('OAuth callback error:', error);
          showError('‚ùå ' + (error.message || 'L·ªói khi x·ª≠ l√Ω ƒëƒÉng nh·∫≠p Discord'));
        }
      })();
    } else if (error) {
      // OAuth error
      showError('‚ùå Discord ƒë√£ t·ª´ ch·ªëi y√™u c·∫ßu ƒëƒÉng nh·∫≠p: ' + error);
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Wait for Auth module to load
    let authReady = false;
    const checkAuthReady = setInterval(() => {
      if (window.Auth) {
        authReady = true;
        clearInterval(checkAuthReady);
        initLoginPage();
      }
    }, 100);

    // Initialize login page
    function initLoginPage() {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      
      // Check backend connection on page load
      (async () => {
        const apiUrl = window.Auth.getAPIUrl();
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
        
        try {
          const response = await fetch(`${apiUrl}/auth/discord-config`, {
            method: 'GET',
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error('Backend returned error');
          }
          
          const data = await response.json();
          
          if (!data.clientId) {
            showError('‚ö†Ô∏è Discord Client ID ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh trong backend. Vui l√≤ng ki·ªÉm tra file <code>backend/.env</code> v√† kh·ªüi ƒë·ªông l·∫°i server.');
          }
        } catch (error) {
          clearTimeout(timeoutId);
          
          // Backend not running or network error
          if (error.name === 'AbortError' || error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            const backendUrl = apiUrl.replace('/api', '');
            showError('‚ö†Ô∏è Backend server ch∆∞a ƒë∆∞·ª£c kh·ªüi ƒë·ªông!<br><br>' +
                     'üìã <strong>ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng ƒëƒÉng nh·∫≠p Discord:</strong><br>' +
                     `1. M·ªü terminal v√† ch·∫°y: <code>cd backend && npm start</code><br>` +
                     `2. ƒê·∫£m b·∫£o server ch·∫°y t·∫°i: <code>${backendUrl}</code><br>` +
                     '3. L√†m m·ªõi trang n√†y sau khi server ƒë√£ ch·∫°y');
          }
        }
      })();

      function showError(message) {
        errorMessage.innerHTML = message.replace(/\n/g, '<br>');
        errorMessage.classList.add('show');
        successMessage.classList.remove('show');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.classList.add('show');
        errorMessage.classList.remove('show');
      }

      // Discord OAuth2 Login Button
      const discordOAuthBtn = document.getElementById('discordOAuthBtn');
      const discordOAuthBtnText = document.getElementById('discordOAuthBtnText');

      discordOAuthBtn.addEventListener('click', async () => {
        try {
          discordOAuthBtnText.textContent = 'ƒêang chuy·ªÉn h∆∞·ªõng...';
          discordOAuthBtn.disabled = true;
          errorMessage.classList.remove('show');
          successMessage.classList.remove('show');

          await window.Auth.discordOAuth2Login();
        } catch (error) {
          console.error('Discord OAuth2 login error:', error);
          
          let errorMsg = '‚ùå L·ªói khi ƒëƒÉng nh·∫≠p v·ªõi Discord';
          
          if (error.message === 'BACKEND_NOT_RUNNING') {
            const apiUrl = window.Auth.getAPIUrl();
            const backendUrl = apiUrl.replace('/api', '');
            errorMsg = '‚ùå Backend server ch∆∞a ƒë∆∞·ª£c kh·ªüi ƒë·ªông!<br><br>' +
                       'üìã <strong>C√°ch kh·∫Øc ph·ª•c:</strong><br>' +
                       `1. M·ªü terminal v√† ch·∫°y: <code>cd backend && npm start</code><br>` +
                       `2. ƒê·∫£m b·∫£o server ch·∫°y t·∫°i: <code>${backendUrl}</code><br>` +
                       '3. Sau ƒë√≥ th·ª≠ l·∫°i';
          } else if (error.message === 'DISCORD_CLIENT_ID_NOT_CONFIGURED') {
            errorMsg = '‚ùå Discord Client ID ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!<br><br>' +
                       'üìã <strong>C√°ch kh·∫Øc ph·ª•c:</strong><br>' +
                       '1. Ki·ªÉm tra file <code>backend/.env</code><br>' +
                       '2. ƒê·∫£m b·∫£o c√≥ d√≤ng: <code>DISCORD_CLIENT_ID=your_client_id</code><br>' +
                       '3. Kh·ªüi ƒë·ªông l·∫°i backend server';
          } else if (error.message) {
            errorMsg = '‚ùå ' + error.message;
          }
          
          showError(errorMsg);
          discordOAuthBtnText.textContent = 'ƒêƒÉng nh·∫≠p v·ªõi Discord';
          discordOAuthBtn.disabled = false;
        }
      });

      // Discord Bot Verification Login
      const discordBotBtn = document.getElementById('discordBotBtn');
      const discordBotBtnText = document.getElementById('discordBotBtnText');
    const verificationSection = document.getElementById('verificationSection');
    const verificationCode = document.getElementById('verificationCode');
    const verificationStatus = document.getElementById('verificationStatus');
    const countdownElement = document.getElementById('countdown');
    
    let verificationCodeValue = null;
    let verificationInterval = null;
    let countdownInterval = null;
    let countdownSeconds = 300; // 5 minutes

    // Format countdown time
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Start countdown
    function startCountdown() {
      countdownSeconds = 300;
      countdownElement.textContent = formatTime(countdownSeconds);
      
      if (countdownInterval) clearInterval(countdownInterval);
      
      countdownInterval = setInterval(() => {
        countdownSeconds--;
        countdownElement.textContent = formatTime(countdownSeconds);
        
        if (countdownSeconds <= 0) {
          clearInterval(countdownInterval);
          verificationStatus.textContent = '‚ùå Code ƒë√£ h·∫øt h·∫°n. Vui l√≤ng t·∫°o code m·ªõi.';
          verificationStatus.style.color = '#ff8a8a';
          if (verificationInterval) clearInterval(verificationInterval);
        }
      }, 1000);
    }

      // Check verification status
      async function checkVerificationStatus() {
        if (!verificationCodeValue) return;

        try {
          const result = await window.Auth.checkVerification(verificationCodeValue);

          if (result.verified) {
            // Verification successful!
            clearInterval(verificationInterval);
            clearInterval(countdownInterval);
            
            verificationStatus.textContent = '‚úÖ X√°c th·ª±c th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...';
            verificationStatus.style.color = '#6ee7a0';
            showSuccess('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng...');

            // Redirect based on role
            setTimeout(() => {
              window.Auth.redirectToDashboard(result.user);
            }, 1200);
          } else if (result.error) {
            // Error occurred
            clearInterval(verificationInterval);
            clearInterval(countdownInterval);
            verificationStatus.textContent = '‚ùå ' + result.error;
            verificationStatus.style.color = '#ff8a8a';
            showError('‚ùå ' + result.error);
          }
          // Otherwise, still waiting...
        } catch (error) {
          console.error('Error checking verification:', error);
          // Don't show error, just keep polling
        }
      }

      // Create verification code
      discordBotBtn.addEventListener('click', async () => {
        try {
          discordBotBtnText.textContent = 'ƒêang t·∫°o code...';
          discordBotBtn.disabled = true;
          errorMessage.classList.remove('show');
          successMessage.classList.remove('show');

          const result = await window.Auth.createVerificationCode();

          // Show verification section
          verificationCodeValue = result.code;
          verificationCode.textContent = result.code;
          verificationSection.style.display = 'block';
          verificationStatus.textContent = '‚è≥ ƒêang ch·ªù x√°c th·ª±c...';
          verificationStatus.style.color = 'var(--text-muted)';

          // Start countdown
          startCountdown();

          // Start polling for verification
          if (verificationInterval) clearInterval(verificationInterval);
          verificationInterval = setInterval(checkVerificationStatus, 2000); // Check every 2 seconds

          // Scroll to verification section
          verificationSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        } catch (error) {
          console.error('Discord bot login error:', error);
          showError('‚ùå ' + (error.message || 'L·ªói khi t·∫°o verification code. Vui l√≤ng th·ª≠ l·∫°i.'));
          discordBotBtnText.textContent = 'Li√™n k·∫øt v·ªõi Bot Discord c·ªßa Gang';
          discordBotBtn.disabled = false;
        }
      });

      // Legacy form (hidden by default)
      const form = document.getElementById('loginForm');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const loading = document.getElementById('loading');
      const btnText = document.getElementById('btnText');

    // Validate username and password
    function validateInputs() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      // Clear previous errors
      usernameInput.style.borderColor = '';
      passwordInput.style.borderColor = '';

      let isValid = true;
      let errors = [];

      if (!username) {
        usernameInput.style.borderColor = 'rgba(255, 107, 107, 0.6)';
        errors.push('T√™n ƒëƒÉng nh·∫≠p kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
        isValid = false;
      } else if (username.length < 3) {
        usernameInput.style.borderColor = 'rgba(255, 107, 107, 0.6)';
        errors.push('T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
        isValid = false;
      }

      if (!password) {
        passwordInput.style.borderColor = 'rgba(255, 107, 107, 0.6)';
        errors.push('M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
        isValid = false;
      } else if (password.length < 4) {
        passwordInput.style.borderColor = 'rgba(255, 107, 107, 0.6)';
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±');
        isValid = false;
      }

      if (!isValid) {
        showError('‚ö†Ô∏è ' + errors.join('<br>'));
      }

      return isValid;
    }

    // Enter key to submit
    [usernameInput, passwordInput].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') form.dispatchEvent(new Event('submit'));
      });
    });

    // Test backend connection (optional - can be used for pre-check)
    async function testBackendConnection() {
      try {
        const response = await fetch(`${API_URL}/health`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.classList.remove('show');
      successMessage.classList.remove('show');

      // Validate inputs first
      if (!validateInputs()) {
        return;
      }

      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      loading.classList.add('show');
      btnText.textContent = 'ƒêang k·∫øt n·ªëi...';
      form.querySelector('button').disabled = true;

      try {
        const apiUrl = window.Auth.getAPIUrl();
        const response = await fetch(`${apiUrl}/auth/login`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ username, password }),
          credentials: 'omit'
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        let data;
        
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          throw new Error('Server tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá');
        }

        if (!response.ok) {
          const errorMsg = data.error || data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
          showError('‚ùå ' + errorMsg);
          
          // Highlight invalid fields
          if (errorMsg.includes('username') || errorMsg.includes('t√™n ƒëƒÉng nh·∫≠p')) {
            usernameInput.style.borderColor = 'rgba(255, 107, 107, 0.6)';
            usernameInput.focus();
          }
          if (errorMsg.includes('password') || errorMsg.includes('m·∫≠t kh·∫©u')) {
            passwordInput.style.borderColor = 'rgba(255, 107, 107, 0.6)';
            passwordInput.focus();
          }
          
          return;
        }

        // Check if response has required fields
        if (!data.token || !data.user) {
          showError('‚ùå Ph·∫£n h·ªìi t·ª´ server kh√¥ng h·ª£p l·ªá');
          return;
        }

        // Save token and user data
        window.Auth.saveAuth(data.token, data.user);

        showSuccess('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng...');

        // Redirect based on role
        setTimeout(() => {
          window.Auth.redirectToDashboard(data.user);
        }, 1200);
      } catch (error) {
        console.error('Login error:', error);
        let errorMsg = '';
        
        if (error.message === 'Failed to fetch' || error.message.includes('fetch') || error.name === 'TypeError') {
          const apiUrl = window.Auth.getAPIUrl();
          const backendUrl = apiUrl.replace('/api', '');
          errorMsg = '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra:<br>' +
                     `1. Backend server ƒë√£ ch·∫°y ch∆∞a? (${backendUrl})<br>` +
                     '2. Ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt l·ªói<br>' +
                     '3. Ki·ªÉm tra k·∫øt n·ªëi internet';
        } else if (error.message.includes('JSON')) {
          errorMsg = '‚ùå L·ªói x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ server. Vui l√≤ng th·ª≠ l·∫°i sau.';
        } else {
          errorMsg = '‚ùå L·ªói: ' + error.message;
        }
        
        showError(errorMsg);
      } finally {
        loading.classList.remove('show');
        btnText.textContent = 'ƒêƒÉng nh·∫≠p';
        form.querySelector('button').disabled = false;
      }
    });

    // Focus effects and validation on blur
    usernameInput.addEventListener('focus', function() {
      this.style.borderColor = 'rgba(255, 95, 175, 0.6)';
    });

    usernameInput.addEventListener('blur', function() {
      if (this.value.trim().length > 0 && this.value.trim().length < 3) {
        this.style.borderColor = 'rgba(255, 107, 107, 0.6)';
      } else {
        this.style.borderColor = 'rgba(255, 182, 219, 0.2)';
      }
    });

    passwordInput.addEventListener('focus', function() {
      this.style.borderColor = 'rgba(255, 95, 175, 0.6)';
    });

    passwordInput.addEventListener('blur', function() {
      if (this.value.length > 0 && this.value.length < 4) {
        this.style.borderColor = 'rgba(255, 107, 107, 0.6)';
      } else {
        this.style.borderColor = 'rgba(255, 182, 219, 0.2)';
      }
    });

    // Real-time validation feedback
    usernameInput.addEventListener('input', function() {
      if (this.value.trim().length >= 3) {
        this.style.borderColor = 'rgba(81, 207, 102, 0.5)';
      } else if (this.value.trim().length > 0) {
        this.style.borderColor = 'rgba(255, 107, 107, 0.6)';
      } else {
        this.style.borderColor = 'rgba(255, 182, 219, 0.2)';
      }
    });

    passwordInput.addEventListener('input', function() {
      if (this.value.length >= 4) {
        this.style.borderColor = 'rgba(81, 207, 102, 0.5)';
      } else if (this.value.length > 0) {
        this.style.borderColor = 'rgba(255, 107, 107, 0.6)';
      } else {
        this.style.borderColor = 'rgba(255, 182, 219, 0.2)';
      }
    });

    }

    // Global error/success functions for OAuth callback
    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      errorMessage.innerHTML = message.replace(/\n/g, '<br>');
      errorMessage.classList.add('show');
      successMessage.classList.remove('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showSuccess(message) {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      successMessage.textContent = message;
      successMessage.classList.add('show');
      errorMessage.classList.remove('show');
    }
  </script>
</body>
</html>

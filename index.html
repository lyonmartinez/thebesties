<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Basic Content Security Policy for static site (adjust domain list as needed) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src https:; connect-src 'self' https:;">
    <title>The Besties Gang Wiki | FiveM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="config.js"></script>
  </head>
  <body>
    <div class="bg-blur"></div>
    <header class="topbar">
      <div class="logo">
        <img class="logo-badge" src="images/logo_thebesties.png" alt="The Besties Logo" />
        <span class="logo-text">The Besties Wiki</span>
      </div>
      <div class="security-badge" title="Trang chính thức. Kiểm tra link Discord trước khi vào."></div>
      <nav class="nav">
        <div class="nav-dropdown">
          <button class="nav-toggle">
            Danh mục
            <span class="nav-chevron">˅</span>
          </button>
          <div class="nav-menu">
            <a href="#overview">Giới thiệu</a>
            <a href="#leader">Leader</a>
            <a href="#members">Thành viên</a>
            <a href="#security">Bảo mật</a>
            <a href="#news">Tin tức</a>
            <a href="#discord">Discord</a>
          </div>
        </div>
      </nav>
    </header>

    <main>
      <section class="hero">
        <div class="hero-content">
          <p class="tag">THE BESTIES Wiki</p>
          <h1>The Besties Gang Wiki</h1>
          <p class="subtitle">
            Trang wiki chính thức tổng hợp mọi thông tin về Gang The Besties:  
            tiểu sử hình thành, Leader, thành viên, tin tức cập nhật và kênh Discord kết nối cộng đồng.
          </p>
          <div class="hero-actions">
            <a href="#overview" class="btn primary">Xem tiểu sử Gang</a>
            <a href="dashboard/login.html" class="btn ghost">Đăng nhập với Discord</a>
          </div>
        </div>
        
      </section>

      <section id="overview" class="section">
        <div class="section-header">
          <h2>The Besties Gang • Tiểu sử</h2>
        </div>

        <div class="member-profile-layout" style="margin-top:18px;">
          <aside class="member-profile-meta">
            <div class="avatar-large">
              <img id="gangLogo" src="images/logo_thebesties.png" alt="The Besties Gang" style="width:72px;height:72px;border-radius:999px;display:block;object-fit:cover;" />
            </div>
            <h3 class="member-profile-role">The Besties • FiveM Gang</h3>

            <div class="member-profile-info">
              <div>
                <dt>Ngôn ngữ</dt>
                <dd>Tiếng Việt</dd>
              </div>
              <div>
                <dt>Server</dt>
                <dd>Let's Roleplay</dd>
              </div>
              <div>
                <dt>Thành lập</dt>
                <dd>2025</dd>
              </div>
            </div>
          </aside>

          <div class="member-profile-content">
            <h3>The Besties Gang</h3>
            <p>
              The Besties được tạo ra để những người bạn thân có thể cùng nhau làm nhiệm vụ, phá đảo
              server và tạo nên những kỷ niệm không quên trong FiveM. Mang vibe hồng ngọt nhưng cực cháy
              – luôn chơi fair, bảo vệ đồng đội và tôn trọng mọi người trong server.
            </p>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
              <span class="leader-tags" style="margin:0;padding:0;gap:8px;display:inline-flex;">
                <span>Teamwork</span>
                <span>Hồng & Power</span>
                <span>FiveM</span>
              </span>
            </div>

            <section style="margin-top:18px;">
              <h4>Sứ mệnh & Giá trị</h4>
              <p>
                <strong>Sứ mệnh:</strong> Mang vibe hồng ngọt nhưng cực cháy – luôn chơi fair, bảo vệ đồng đội
                và tôn trọng mọi người trong server.
              </p>
              <p>
                <strong>Phong cách:</strong> Style hồng trắng nổi bật, luôn xuất hiện với thần thái tự tin,
                teamwork đỉnh cao và tiếng cười không bao giờ tắt.
              </p>
              <p>
                <strong>Giá trị:</strong> Tôn trọng – Trung thành – Vui vẻ. Ai vào The Besties cũng là bạn, là người nhà.
              </p>
            </section>

            <section style="margin-top:24px;">
              <h4>Ảnh & Khoảnh khắc Gang</h4>
              <div class="member-gallery" id="gangGallery">
                <!-- Gallery images loaded dynamically -->
              </div>
            </section>
          </div>
        </div>
      </section>

      <section id="leader" class="section section-accent">
        <div class="section-header">
          <h2>Leader</h2>
          <p>Thủ lĩnh dẫn dắt The Besties, giữ lửa cho cả Gang trong mọi tình huống.</p>
        </div>

        <div class="leader-card" style="align-items:center;">
          <div class="leader-avatar">
            <span class="crown">★</span>
            <img id="leaderPhoto" class="leader-photo" src="members/leader/leader.jpg" alt="Leader Name" />
            <div id="leaderPlaceholder" style="display:none; width:100%; height:100%; background:linear-gradient(135deg, #ff5faf, #ff2b8a); border-radius:999px; display:flex; align-items:center; justify-content:center; color:white; font-size:48px; font-weight:bold;">L</div>
          </div>
          <div class="leader-info">
            <h3 class="leader-name">Leader Name</h3>
            <p class="leader-role">Gang Leader • The Besties</p>
            <p class="leader-desc">Tóm tắt: Người lãnh đạo quyết đoán, luôn bảo vệ team và lên kế hoạch cho mọi nhiệm vụ.</p>
            <div style="margin-top:10px;">
              <a class="btn primary" href="members/leader/index.html">Xem hồ sơ Leader</a>
            </div>
          </div>
        </div>
      </section>

      <section id="members" class="section">
        <div class="section-header">
          <h2>Thành viên</h2>
          <p>Những mảnh ghép tạo nên The Besties – mỗi người một màu, nhưng cùng chung 1 Gang.</p>
        </div>
        <div class="member-grid" id="membersGrid">
          <p style="text-align: center; color: var(--text-muted); grid-column: 1 / -1;">Đang tải danh sách thành viên...</p>
        </div>
      </section>

      <section id="security" class="section section-soft">
        <div class="section-header">
          <h2>Bảo mật &amp; An toàn khi dùng Wiki</h2>
          <p>
            Một vài nguyên tắc giúp bảo vệ thông tin của bạn và giữ cho cộng đồng The Besties an toàn,
            hạn chế lừa đảo hoặc lợi dụng danh nghĩa Gang.
          </p>
        </div>
        <div class="security-grid">
          <div class="security-card">
            <h3>1. Không chia sẻ thông tin nhạy cảm</h3>
            <p>
              Không đăng số điện thoại, địa chỉ nhà, tài khoản ngân hàng hoặc thông tin cá nhân quan trọng
              lên website / Discord của Gang nếu không thật sự cần thiết.
            </p>
          </div>
          <div class="security-card security-verify">
            <h3>Xác thực Discord &amp; Liên kết</h3>
            <p style="margin-bottom:8px;">
              Luôn kiểm tra đường link mời Discord trước khi bấm. Link chính thức của Gang được đặt ở nút
              <strong>Vào Discord Gang</strong> ở phần dưới trang.
            </p>
            <a class="btn ghost" href="mailto:security@thebesties.example?subject=Report%20suspicious%20account">Báo cáo hành vi đáng ngờ</a>
          </div>
          <div class="security-card">
            <h3>2. Cẩn thận với link lạ</h3>
            <p>
              Chỉ click vào các link được Leader / quản trị xác nhận. Nếu có người gửi link lạ, bảo là
              “event Gang” hoặc “nhận quà”, bạn nên hỏi lại trong kênh chung để kiểm tra.
            </p>
          </div>
          <div class="security-card">
            <h3>3. Xác nhận đúng Discord chính thức</h3>
            <p>
              Server Discord chính thức của The Besties luôn được ghi rõ ở mục <strong>Discord</strong> trên wiki.
              Nếu ai gửi bạn một server khác và nói là “The Besties mới”, hãy chụp lại và hỏi Leader để xác minh.
            </p>
          </div>
          <div class="security-card">
            <h3>4. Báo cáo khi thấy hành vi đáng ngờ</h3>
            <p>
              Nếu có ai mạo danh Leader / thành viên core team, đòi tiền, đồ hoặc pass tài khoản, hãy
              chụp màn hình và báo ngay cho Leader / quản trị viên trong Discord để xử lý.
            </p>
          </div>
          <div class="security-card">
            <h3>5. Tài khoản &amp; mật khẩu</h3>
            <p>
              Không đưa mật khẩu tài khoản game / Discord cho bất kỳ ai, kể cả người nói là “staff server”.
              The Besties không bao giờ yêu cầu bạn gửi mật khẩu riêng tư.
            </p>
          </div>
          <div class="security-card">
            <h3>6. Chỉnh sửa Wiki an toàn</h3>
            <p>
              Khi chỉnh sửa file <code>index.html</code> hoặc <code>style.css</code>, bạn nên lưu một bản backup
              để tránh mất nội dung. Không chèn script lạ nếu bạn không chắc nó an toàn.
            </p>
          </div>
        </div>
      </section>

      <section id="news" class="section section-soft">
        <div class="section-header">
          <h2>Tin tức &amp; Cập nhật Gang</h2>
        </div>
        <div class="news-list">
          <article class="news-item">
            <div class="news-meta">
              <span class="news-badge">Mới</span>
              <span class="news-date">27/11/2025</span>
            </div>
            <h3 class="news-title">[Ví dụ] Tuyển thêm thành viên core team</h3>
            <p class="news-body">
              The Besties đang mở slot cho vài thành viên tryhard, ưu tiên những người online ổn định,
              teamwork tốt và sử dụng mic. Liên hệ Leader hoặc vào Discord để phỏng vấn.
            </p>
          </article>
          <article class="news-item">
            <div class="news-meta">
              <span class="news-date">20/11/2025</span>
            </div>
            <h3 class="news-title">[Ví dụ] The Besties ký liên minh với 1 Gang khác</h3>
            <p class="news-body">
              Sau một vài buổi war vui vẻ, The Besties thống nhất lập liên minh với 1 Gang bạn,
              ưu tiên cùng nhau làm job lớn và hỗ trợ khi có conflict trong server.
            </p>
          </article>
          <p class="news-note">
            Bạn có thể tự sửa, xóa hoặc thêm các dòng tin tức mới trong mục <strong>Tin tức &amp; Cập nhật Gang</strong>
            ở file <code>index.html</code> bất cứ khi nào có update.
          </p>
        </div>
      </section>

      <section id="discord" class="section section-accent">
        <div class="section-header">
          <h2>Discord chính thức của The Besties</h2>
          <p>
            Nơi tụ họp của cả Gang và bạn bè: chat, lên kèo, báo lịch, share ảnh highlight và giải quyết
            mọi chuyện liên quan đến The Besties.
          </p>
        </div>
        <div class="discord-card">
          <div class="discord-info">
            <p class="discord-label">Server Discord</p>
            <p class="discord-name">The Besties • FiveM Gang</p>
            <p class="discord-desc">
              Bấm nút bên cạnh để vào thẳng Discord.  
              Hãy thay link mời thật của bạn vào trong file <code>index.html</code> để mọi người dùng được.
            </p>
          </div>
          <div class="discord-actions">
            <a
              href="https://discord.gg/thebesties"
              target="_blank"
                  rel="noopener noreferrer"
              class="btn primary discord-btn"
            >
              Vào Discord Gang
            </a>
          </div>
        </div>
      </section>

      <!-- Small script: ensure external links use noopener/noreferrer -->
      <script>
        document.addEventListener('DOMContentLoaded', function(){
          document.querySelectorAll('a[target="_blank"]').forEach(function(a){
            var rel = a.getAttribute('rel') || '';
            if(!/noopener/i.test(rel)) rel += ' noopener';
            if(!/noreferrer/i.test(rel)) rel += ' noreferrer';
            a.setAttribute('rel', rel.trim());
          });
        });
      </script>
    </main>

    <!-- Lightbox modal for gallery images -->
    <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-label="Image preview">
      <div class="lightbox-inner" role="document">
        <button class="lightbox-close" aria-label="Close">×</button>
        <img src="" alt="" />
        <figcaption></figcaption>
      </div>
    </div>

    <script>
      // Simple lightbox (no dependencies)
      (function(){
        var lightbox = document.getElementById('lightbox');
        var lbImg = lightbox.querySelector('img');
        var lbCaption = lightbox.querySelector('figcaption');
        var closeBtn = lightbox.querySelector('.lightbox-close');

        function openLightbox(src, alt, caption){
          lbImg.src = src;
          lbImg.alt = alt || '';
          lbCaption.textContent = caption || '';
          lightbox.setAttribute('aria-hidden','false');
          lightbox.classList.add('open');
          document.body.style.overflow = 'hidden';
        }

        function closeLightbox(){
          lightbox.classList.remove('open');
          lightbox.setAttribute('aria-hidden','true');
          lbImg.src = '';
          lbCaption.textContent = '';
          document.body.style.overflow = '';
        }

        // Click thumbnails
        document.addEventListener('click', function(e){
          var fig = e.target.closest('.member-photo');
          if(!fig) return;
          var img = fig.querySelector('img');
          if(!img) return;
          e.preventDefault();
          openLightbox(img.src, img.alt, fig.querySelector('figcaption') ? fig.querySelector('figcaption').textContent : '');
        });

        closeBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', function(e){ if(e.target === lightbox) closeLightbox(); });
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeLightbox(); });
      })();
    </script>

    <script>
      // Handle image errors to avoid CSP violations
      document.addEventListener('DOMContentLoaded', function() {
        // Handle logo error
        const gangLogo = document.getElementById('gangLogo');
        if (gangLogo) {
          gangLogo.addEventListener('error', function() {
            this.style.display = 'none';
          });
        }
        
        // Handle leader photo error
        const leaderPhoto = document.getElementById('leaderPhoto');
        const leaderPlaceholder = document.getElementById('leaderPlaceholder');
        if (leaderPhoto && leaderPlaceholder) {
          leaderPhoto.addEventListener('error', function() {
            this.style.display = 'none';
            leaderPlaceholder.style.display = 'flex';
          });
        }
        
        // Load gallery images dynamically
        const gallery = document.getElementById('gangGallery');
        if (gallery) {
          const images = [
            { src: 'images/gang1.jpg', caption: 'Khoảnh khắc chiến thuật' },
            { src: 'images/gang2.jpg', caption: 'Cùng team' },
            { src: 'images/gang3.jpg', caption: 'Thắng lợi' },
            { src: 'images/gang4.jpg', caption: 'Trong nhiệm vụ' },
            { src: 'images/gang5.jpg', caption: 'Khoảnh khắc đặc biệt' },
            { src: 'images/gang6.jpg', caption: 'Highlight của Gang' }
          ];
          
          images.forEach(function(img) {
            const figure = document.createElement('figure');
            figure.className = 'member-photo';
            const imgEl = document.createElement('img');
            imgEl.src = img.src;
            imgEl.alt = img.caption;
            imgEl.addEventListener('error', function() {
              figure.style.display = 'none';
            });
            const caption = document.createElement('figcaption');
            caption.textContent = img.caption;
            figure.appendChild(imgEl);
            figure.appendChild(caption);
            gallery.appendChild(figure);
          });
        }
      });
      
      // Load members from API (wait for DOM and config to be ready)
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for config.js to load if needed
        setTimeout(function() {
          // Auto-detect API URL
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const API_URL = window.APP_CONFIG?.API_URL || (isLocalhost ? 'http://localhost:5000/api' : 'https://thebesties-backend.onrender.com/api');
          const membersGrid = document.getElementById('membersGrid');
          
          if (!membersGrid) {
            console.error('Members grid not found');
            return;
          }
          
          // Generate avatar letter from name
          function getAvatarLetter(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
          }

          // Display members helper function
          function displayMembers(members) {
            if (members.length === 0) {
              membersGrid.innerHTML = '<p style="text-align: center; color: var(--text-muted); grid-column: 1 / -1;">Chưa có thành viên nào</p>';
              return;
            }
            
            // Generate member cards
            membersGrid.innerHTML = members.map((member, index) => {
              const avatarUrl = member.discordAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=ff5faf&color=fff&size=120`;
              const avatarLetter = getAvatarLetter(member.name);
              const memberLink = member.folder ? `members/${member.folder}/index.html` : '#';
              
              return `
                <a class="member-card" href="${memberLink}">
                  <div class="member-avatar" style="background-image: url('${avatarUrl}'); background-size: cover; background-position: center; ${!member.discordAvatar ? 'display: flex; align-items: center; justify-content: center;' : ''}">
                    ${!member.discordAvatar ? `<span style="font-size: 48px; font-weight: bold; color: white;">${avatarLetter}</span>` : ''}
                  </div>
                  <h3 class="member-name">${member.name || 'Thành viên'}</h3>
                  <p class="member-role">${member.character || 'Thành viên Gang'}</p>
                  <p class="member-desc">
                    Thành viên của The Besties Gang
                  </p>
                </a>
              `;
            }).join('');
          }

          // Load and display members
          async function loadMembers() {
            try {
              console.log('Loading members from:', API_URL);
              
              // Create timeout manually for better browser compatibility
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
              
              // Try to load from API first
              const response = await fetch(`${API_URL}/leader/public/members?t=${Date.now()}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                  'Cache-Control': 'no-cache'
                },
                signal: controller.signal,
                cache: 'no-store'
              });
              
              clearTimeout(timeoutId);
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const data = await response.json();
              const members = data.members || [];
              
              console.log('Loaded members from API:', members.length);
              displayMembers(members);
              
            } catch (error) {
              console.warn('API failed, trying fallback:', error);
              
              // Fallback: Try to load from static JSON file
              try {
                const fallbackResponse = await fetch('data/members.json?t=' + Date.now(), {
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  cache: 'no-store'
                });
                
                if (fallbackResponse.ok) {
                  const fallbackData = await fallbackResponse.json();
                  const members = fallbackData.members || [];
                  console.log('Loaded members from fallback:', members.length);
                  displayMembers(members);
                  return;
                }
              } catch (fallbackError) {
                console.error('Fallback also failed:', fallbackError);
              }
              
              // If both fail, show error
              let errorMsg = 'Không thể tải danh sách thành viên.';
              
              if (error.name === 'AbortError' || error.message.includes('timeout')) {
                errorMsg += ' Backend không phản hồi.';
              } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'TypeError') {
                errorMsg += ' Backend đang offline hoặc không thể kết nối.';
              } else {
                errorMsg += ' ' + (error.message || 'Lỗi không xác định');
              }
              
              membersGrid.innerHTML = `<p style="text-align: center; color: #ff6b6b; grid-column: 1 / -1; padding: 20px;">${errorMsg}<br><small style="color: var(--text-muted);">Vui lòng thử lại sau hoặc liên hệ Leader.</small></p>`;
            }
          }
          
          // Load members
          loadMembers();
        }, 100); // Small delay to ensure config.js is loaded
      });
    </script>

    <footer class="footer">
      <p>
        The Besties Gang • FiveM  
        <span class="footer-sub"></span>
      </p>
    </footer>
  </body>
</html>


